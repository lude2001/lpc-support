# LPC 语言支持插件改进计划 (v2 - ANTLR/AST 驱动)

本文档旨在规划和跟踪 LPC 语言支持 VS Code 插件的核心功能改进。根据新的需求，我们将放弃原有的基于正则表达式的 TextMate 语法增强方案，转向**使用 ANTLR 构建一个完整的 LPC 语言解析器**，并生成抽象语法树 (AST)。这个 AST 将成为所有高级语言功能（包括精确的语法高亮、错误诊断、代码补全、定义跳转等）的基石。

## 总体原则

- **AST 优先**: 所有语言功能的实现都应优先基于 AST，以确保准确性和可扩展性。
- **分步实施**: 将庞大的解析器和语言服务开发工作分解为多个可管理、可验证的阶段。
- **文档驱动**: 自行研究和整理 LPC 语言规范，独立编写 ANTLR 语法文件。
- **中文记录**: 所有规划和变更日志都使用中文记录。

## 改进阶段

### 第一阶段：ANTLR 语法定义与解析器生成 (ANTLR Grammar & Parser Generation)

- **状态**: ✅ **已完成**
- **目标**: 创建一个能够解析 LPC 代码并生成 AST 的核心解析器。

### 第二阶段：基于 AST 的语言功能基础实现 (Basic Features via AST)

- **状态**: ✅ **已完成**
- **目标**: 利用生成的 AST，搭建语言服务的基础，并实现最核心的诊断和导航功能。
- **产出**:
    1.  **错误诊断 (Diagnostics)**: 服务器能够捕获基本语法错误并在编辑器中高亮。
    2.  **文档符号 (Document Symbols)**: 支持 "Go to Symbol in File..." (`Ctrl+Shift+O`)。

### 第三阶段：高级功能实现与旧代码迁移 (Advanced Features & Migration)

- **状态**: **进行中**
- **目标**: 逐一实现高级语言功能，每完成一项，便替换掉 `src/` 目录下对应的旧模块，最终完成插件的现代化重构。
- **任务队列**:
    1.  **语义化高亮 (Semantic Highlighting)**
        -   **目标**: 提供比传统正则表达式更精准的代码着色，能区分变量、函数、参数等。
        -   **替换**: 这是纯新增功能，不直接替换旧模块，但为未来的功能打下基础。
    2.  **语义诊断增强 (Enhanced Diagnostics)**
        -   **目标**: 遍历 AST，实现对“未使用变量”、“未定义函数调用”等语义层面的检查。
        -   **替换**: `src/diagnostics.ts`
    3.  **代码补全 (Completion)**
        -   **目标**: 实现 `onCompletion` 处理器。根据光标在 AST 中的上下文，提供变量、函数、efun、宏等的智能提示。
        -   **替换**: `src/completionProvider.ts`
    4.  **定义跳转 (Go to Definition)**
        -   **目标**: 实现 `onDefinition` 处理器。通过在服务端构建跨文件的符号表，实现精准的函数和变量定义跳转。
        -   **替换**: `src/definitionProvider.ts`
    5.  **悬停提示 (Hover)**
        -   **目标**: 实现 `onHover` 处理器。当鼠标悬停时，查询符号表或文档，显示变量类型、函数签名和注释文档。
        -   **替换**: `src/efunDocs.ts` 及其他相关模块。

## 变更日志

每次完成一个阶段性改进后，将在 `CHANGELOG_IMPROVEMENTS.md` 文件中进行详细记录。